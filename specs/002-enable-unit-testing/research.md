# Research: Unit Testing Infrastructure

**Feature**: Enable Unit Testing (`002-enable-unit-testing`)
**Date**: 2026-01-02

## 1. Mocking Patterns

### Go (`testify`)

- **Current State**: `github.com/stretchr/testify` is present in `go.mod` as an indirect dependency (v1.11.1).
- **Decision**: Promote `testify` to a direct dependency.
- **Pattern**:
  - Use `github.com/stretchr/testify/assert` for assertions.
  - Use `github.com/stretchr/testify/mock` for mocking dependencies.
  - **Self-Mocking**: Since `pkg.NewPortfolio` returns a `portfolio.Service` interface (generated by Goa), we can technically generate a mock _of_ the service using `mockery` for testing consumers.
  - **Internal Deps**: The standard pattern for `slog` is to inject it. For testing, we can use `slog.New(slog.DiscardHandler)` or a memory handler from a testing lib.

### Svelte/TS (`vitest`)

- **Current State**: `vitest` is missing from `svelte/package.json`.
- **Decision**: Install `vitest`, `jsdom`, `@testing-library/svelte`, and check `svelte-check` interaction.
- **Pattern**:
  - Use `vi.fn()` for function mocks.
  - Use `vi.mock('$app/navigation')` to mock SvelteKit modules.
  - **Component Testing**: Use `@testing-library/svelte` to render components and query the DOM.

## 2. Dependency Injection (DI) Strategy

### Go

- **Observation**: `pkg/portfolio_service.go` currently implements `portfolio.Service` (from `gen/portfolio`).
- **Refactor**:
  - The service logic is self-contained. To demonstrate DI/Mocking as requested by the user ("checking dependency injection compatibility"), we should ensure the _test_ proves we can swap things.
  - Since there are no external deps (DB/API) yet, the focus is on structure.
  - We will ensure `NewPortfolio` accepts a defined interface if we added a data provider, but for now, the `Logger` is the only dep.
  - **Action**: We will ensure the test `portfolio_service_test.go` treats the service as a black box respecting the `portfolio.Service` interface.

### Svelte

- **Observation**: `PortfolioSummaryWidget.svelte` defines `valuation` data _inside_ the component.
- **Refactor**:
  - Move `valuation` to a prop: `export let valuation: Valuation`.
  - Allows the parent (`PortfolioPage.svelte`) to supply data.
  - **Test Benefit**: We can write a test that passes specific `valuation` data and asserts the rendered text (e.g. "$1,250.00").
  - **Mocking**: Not strictly mocking a _service_ here, but "mocking" the data via props.
  - **Navigation**: Mock `$app/navigation` `goto` to verify click handler.

## 3. Tooling Configuration

- **Moon**:
  - Need to add `test` task to `moon.yml` (or ensure it detects it).
  - Go: `command: go test ./...`
  - Svelte: `command: npx vitest run`

## Decisions Log

- **D001**: Use `vi.mock` for SvelteKit modules (`$app/*`).
- **D002**: Refactor Svelte widgets to "dumb" components (Props-down) for easier testing.
- **D003**: Use `testify/assert` for concise Go tests.
