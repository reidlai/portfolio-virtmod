$schema: 'https://moonrepo.dev/schemas/project.json'
id: 'portfolio-go'
type: 'library'
stack: 'backend'

tasks:
  build:
    command: 'go build ./...'
    inputs:
      - '**/*.go'
      - 'go.mod'
      - 'go.sum'
    outputs: []
    options:
      mergeArgs: 'replace'
      mergeOutputs: 'replace'
      mergeInputs: 'replace'

  format:
    command: "goimports"
    args:
      - "-w"
      - "."
    inputs:
      - "**/*.go"
      - "go.mod"
      - "go.sum"
    platform: "system"
    options:
      mergeArgs: "replace"
      mergeInputs: "replace"

  lint:
    command: "go"
    args:
      - "run"
      - "github.com/golangci/golangci-lint/cmd/golangci-lint@latest"
      - "run"
      - "-v"
    inputs:
      - "**/*.go"
      - "go.mod"
      - "go.sum"
    options:
      mergeArgs: "replace"
      mergeInputs: "replace"

  test:
    command: "go test ./pkg/... ./internal/..."
    inputs:
      - "**/*.go"
      - "go.mod"
      - "go.sum"
    options:
      runInCI: true
      mergeArgs: "replace"
      mergeInputs: 'replace'

  goa-gen:
    command: "go run goa.design/goa/v3/cmd/goa@latest gen github.com/reidlai/ta-workspace/modules/portfolio/go/design --output goa_gen"
    inputs:
      - "design/**/*.go"
      - "go.mod"
    outputs:
      - "goa_gen/**"
    options:
      mergeArgs: "replace"
      mergeInputs: 'replace'

  build-server:
    command: "go build -o bin/portfolio-server ."
    inputs:
      - "main.go"
      - "cmd/**/*.go"
      - "pkg/**/*.go"
      - "gen/**/*.go"
      - "go.mod"
      - "go.sum"
    outputs:
      - "bin/portfolio-server"

  start:
    command: "./bin/portfolio-server"
    deps:
      - "build-server"
    local: true
